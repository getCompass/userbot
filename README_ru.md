[![en](https://img.shields.io/badge/lang-en-green.svg)](https://github.com/getCompass/userbot/blob/master/README.md)
[![ru](https://img.shields.io/badge/lang-ru-green.svg)](https://github.com/getCompass/userbot/blob/master/README_ru.md)

- [Бот](#Бот)
- [Создание бота](#Создание-бота)
    - [Учётные данные бота](#Учётные-данные-бота)
- [Отправка запроса в приложении Compass](#Отправка-запроса-в-приложении-Compass)
    - [Ответ от приложения Compass после отправки запроса](#Ответ-от-приложения-Compass-после-отправки-запроса)
- [Webhook и реагирование на команды](#Webhook-и-реагирование-на-команды)
    - [Ответ на команду пользователя](#Ответ-на-команду-пользователя)
    - [Доступные действия для ответа с webhook](#Доступные-действия-для-ответа-с-webhook)
    - [Версия webhook бота](#Версия-webhook-бота)
- [Список методов Compass Userbot API](#Список-методов-Compass-Userbot-API)
- [Дополнительное форматирование сообщений](#Дополнительное-форматирование-сообщений)
- [Ошибки при выполнении запроса Compass Userbot API](#Ошибки-при-выполнении-запроса-Compass-Userbot-API)
- [Библиотека для работы с API ботов приложения Compass](#Библиотека-для-работы-с-API-ботов-приложения-Compass)

## Бот ##

Бот — это специальный аккаунт в приложении Compass, который создаётся пользователем для автоматического выполнения настраиваемых действий.

Бот Compass умеет:
- отправлять сообщения в личные и групповые чаты;
- ставить реакции на сообщения;
- отправлять файлы в чат;
- получать основную информацию по участникам команды (user_id, имя, URL файла-аватарки).

Перечисленные действия реализуются через специальные запросы, описанные в разделе [Список методов приложения Compass Userbot API](#Список-методов-Compass-Userbot-API).

Также, если включить режим "Реагировать на команды", бот начнёт реагировать на команды, которые вы укажете, и перенаправлять их на адрес вашего webhook (подробнее в разделе [Webhook и реагирование на команды](#Webhook-и-реагирование-на-команды)).

## Создание бота ##

Создание бота доступно пользователю, имеющему права управления ботами.

Данные права можно выдать только участникам с правами в соответствующих настройках. Для этого перейдите в раздел "Участники", выберите пользователя, которому хотите выдать права, и далее — "Редактировать права":

| <img src="./screenshots/ru/1.png" alt="" width="550" /> |
| --- |

| <img src="./screenshots/ru/2.png" alt="" width="400" /> |
| --- |

После редактирования прав у участника обновится меню команды, в нём появится функционал для управления ботами:

| <img src="./screenshots/ru/3.png" alt="" width="550" /> |
| --- |

| <img src="./screenshots/ru/4.png" alt="" width="400" /> |
| --- |

При создании бота вы можете настроить следующие параметры:

- имя бота;
- назначение бота;
- webhook, куда будут перенаправлены команды от участников.

Webhook — это URL-адрес вашего сервиса. После его настройки бот сможет реагировать на сообщения-команды, перенаправляя их на указанный вами адрес.

| <img src="./screenshots/ru/5.png" alt="" width="400" /> |
| --- |

#### Учётные данные бота
После создания бота в разделе «Карточка бота» вам будут предоставлен **Токен** нового бота (виден участникам с правами управления ботами).

**Токен бота (token)** — уникальный для каждого бота идентификатор.

| <img src="./screenshots/ru/6.png" alt="" width="400" /> |
| --- |

⚠️ Обратите внимание: **Токен** вашего бота нельзя сообщать третьим лицам.<br>
Если же это произошло, рекомендуем сменить Токен в приложении Compass через настройки бота:

| <img src="./screenshots/ru/7.png" alt="" width="400" /> |
| --- |

Таким образом, все запросы бота, которые использовали скомпрометированный токен, станут недействительными для приложения Compass.

## Отправка запроса в приложении Compass ##

Запросы к приложению Compass Userbot API должны осуществляться через HTTPS-запрос методом POST, отправленный на endpoint: <br>
`https://userbot.getcompass.com/api/v3/` + (выполняемый метод)<br>

Все запросы должны использовать тип содержимого: **application/json**.<br>
Для загрузки файлов: **multipart/form-data**.

Тело каждого запроса к приложению Compass должно содержать:
- **json-строку** требуемых параметров для запроса (пустой, если данные не требуются).

Авторизация запроса осуществляется через **header**-заголовок с использованием токена вашего бота:<br>
- заголовок "**Authorization: bearer={токен бота}**" - заголовок содержит токен, который принадлежит вашему боту (бот должен быть включён для этого).

Все методы регистрозависимы и должны быть в кодировке UTF-8.

--- 

Рассмотрим запрос на примере отправки сообщения участнику.

Используется метод [/user/send](#post-usersend).<br>
URL для отправляемого запроса: `https://userbot.getcompass.com/api/v3/user/send` <br>

Пример параметров для запроса:
```json5
{
    "text": "Hello, this is bot", // произвольный текст для нового сообщения от бота
    "type": "text",               // указываем, что сообщение является текстовым
    "user_id": 12345              // идентификатор участника, которому отправляется сообщение
}
```

Структура curl-запроса:<br>
<pre style="white-space:pre-wrap;">
curl -X POST -d "<b>{параметры в json-формате}</b>"
-H "Content-Type: application/json"
-H "Authorization: bearer=<b>{токен бота}</b>" 
https://userbot.getcompass.com/api/v3/user/send
</pre>


---

Бот может отправить сообщение в группу, участником которой является, конкретному участнику команды, а также в комментарии к сообщению.

При отправке запроса вам необходимо указать, куда будет отправлено сообщение от бота:

- если необходимо отправить участнику, требуется ID участника, для которого предназначено сообщение;
- если необходимо отправить сообщение в группу, нужен уникальный ключ этой группы;
- если необходимо отправить комментарием к сообщению, нужен ключ сообщения, для которого будет создана ветка комментариев.

#### ID участника

Идентификатор участника (параметр "user_id" в запросах) используется при отправке сообщения конкретному участнику. Его можно получить в приложении Compass через Профиль участника (доступны только пользователям с правами управления ботами):


| <img src="./screenshots/ru/8.png" alt="" width="400" /> |
| --- |

#### Ключ чата

Уникальный идентификатор группы (используется как "group_id" в запросах), участником которой является бот.<br>
Доступен для участника с правами управления ботами из раздела "Меню бота" в групповом чате:

| <img src="./screenshots/ru/9.png" alt="" width="550" /> |
| --- |

Пример ключа чата:

> 3brLYUVlCEbNg6A0m6W2X2zkPyY8PN3Ijw6efI20gVJHGiy4xHOociXAmMh1o/i01gLTS8wHHx7JGrrzIL4zDC6a4qX031dzJfqTzl8MD6Rqv2wd38yfGLS6n6VlwmPQ2hNNXCDPEL9sddmYCfHSSY/BfjXsNvJh3YpBH1pRf1I=

#### Ключ сообщения

Идентификатор сообщения (используется как "message_id" в запросах), с которым работает бот. Пример ключа сообщения:
> oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFxBYmT8vqbF5vNIi4T/YEKZh4yF4iLXo9J4pW/4UguVkB0XY9/vF5pzUHUL4eVr3ScGWEP3fUEWdNlws+pffgp9oUOl+X0HrFxXxuFVfREy6od/psN+lob

---

#### Ответ от приложения Compass после отправки запроса ####

Все запросы к Compass выполняются синхронно и возвращают результат своего выполнения.<br>

Ответ представляет собой json-объект, в котором содержатся поля:
- **status** (string) — отражает статус выполнения запроса.<br>
  Может принимать значение "ok" (в случае, если запрос выполнился успешно) или "error" (в случае ошибки);
- **response** (json) — json-объект произвольных данных.

В случае успешного выполнения поле response может иметь данные выполненного запроса, либо пустое значение.

Рассмотрим схему получения результата на примере отправки сообщения от бота:
- выполним запрос [/user/send](#post-usersend), передав текст: Hello, this is bot 😊
- в случае если сообщение успешно отправлено, метод вернёт результат выполнения запроса — в данном примере это message_id отправленного ботом сообщения:
>```json5
>{
>     "status": "ok",
>     "response": {
>          "message_id": "eNb2VLAPCGFfK1gHzNkH78XNDsPr9N/dDI7f/yaeTof0zjXwv/G000SZFNwqBOx2ACjqSwFjB1Lhgtqn..."
>     }
>}
>```

| <img src="./screenshots/ru/10.png" alt="" width="550" /> |
| --- |

**Пример пустого ответа:**
```json5 
{
    "status": "ok",
    "response": {}
}
```

Если произошла ошибка, поле **status** будет принимать значение "error".

В таком случае поле **response** будет содержать поля:
- **error_code** (int) — код ошибки. Более подробно расписано в разделе [Ошибки при выполнении запроса Compass Userbot API](#Ошибки-при-выполнении-запроса-Compass-Userbot-API);
- **message** (string) — произвольный текст ошибки.

**Пример ответа с ошибкой:**
```json5 
{
    "status": "error",
    "response": {
        "error_code": 1000,
        "message": "invalid parameters: not passed param text for request"
    }
}
```

## Webhook и реагирование на команды

Бот может реагировать на специальные команды-сообщения.<br>
Для добавления команд используется метод [/command/update](#post-commandupdate):

| <img src="./screenshots/ru/11.png" alt="" width="550" /> |
| --- |

Установленные команды будут видны всем участникам команды на экране "Карточка
бота":

| <img src="./screenshots/ru/12.png" alt="" width="400" /> |
| --- |

Когда участник отправляет сообщение-команду боту, у которого включён режим
"Реагировать на команды" и установлен webhook, то на указанный адрес отправляются
данные вида:

> Если команда была отправлена в группе
>
>```json5 
>{
>    "group_id": "3brLYUVlCEbNg6A0m6W2X2zkPyY8PN3Ijw6efI20gVJHGiy4xHOociXAmMh1o/i01gLTS8wHHx7JGrrzIL4z...",
>    "message_id": "oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFxBYmT8vqbF5vNIi4T/YEKZh...",
>    "text": "/покажи список команд"
>    "type": "group",
>    "user_id": 12345,
>}
>```

- group_id — ключ группы, откуда отправлена команда;
- message_id — уникальный идентификатор сообщения-команды;
- text — текст команды, переданной боту;
- type — указывает, откуда пришла команда (single — чат с ботом; group — группа);
- user_id — идентификатор участника пространства, который отправил команду.

> Если команда была отправлена в личном чате с ботом
>
>```json5 
>{
>     "group_id": "",
>     "message_id": "oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFxBYmT8vqbF5vNIi4T/YEKZh...",
>     "text": "/покажи список команд"
>     "type": "single",
>     "user_id": 12345,
>}
>```

⚠️ Обратите внимание: на ваш сервис отправляются только те сообщения, текст которых
совпадает с шаблоном команд, прописанных в настройках бота вашей команды.
**Другие сообщения из чата не отправляются на webhook.**

Запрос будет содержать header-заголовок с токеном того бота, которому принадлежит отправленная команда:<br>
>заголовок "**Authorization: bearer={токен бота}**".<br>

Получив данные на ваш webhook, вы можете:
- по токену в переданном заголовке проверить, что запрос пришёл для вашего бота;
- синхронно ответить на команду пользователя, отправив сообщение в диалог или поставив реакцию на сообщение-команду.

#### Ответ на команду пользователя

Получив сообщение на ваш webhook, у вас есть возможность ответить на команду пользователя, отправив данные в ответе запроса без необходимости вызова метода Compass Userbot API.<br>
Ответ на запрос от бота должен иметь формат **json-строки** требуемых параметров.

Рассмотрим пример отправки ответа на команду пользователя:
- пользователь отправляет в диалог команду для вашего бота;
- запрос с данными команды отправляется на ваш webhook;
- получив данные, необходимо сформировать требуемые параметры и вернуть **в ответе запроса**;
- бот, успешно завершив запрос на webhook, получает ваш ответ и отвечает на комадну пользователю.

> Пример параметров для ответа на команду пользователя в виде сообщения в диалог:
>
>```json5 
>{
>	"answer": {
>		"action": "message_send",
>		"post": {
>			"text": "Привет, это сообщение от бота",
>			"type": "text"
>		}
>	}
>}
>```
- answer - поле, которое содержит json-объект переданных параметров;
- action - действие, которое желаете выполнить в ответе;
- post - объект с post-параметрами.

Если отвечать на отправленную команду не требуется, то передавать данные в ответе запроса не обязательно.

#### Доступные действия для ответа с webhook

| Действие | Для чего используется |
| :--- | :--- |
| [message_send](#message_send) | действие для отправки сообщения от бота на команду пользователя. |
| [thread_send](#thread_send) | действие для отправки сообщения от бота в тред на команду пользователя. |
| [message_addreaction](#message_addreaction) | действие для установки реакции на команду пользователя. |

---

#### `message_send`

Действие для отправки в диалог сообщения от бота на команду пользователя.

Должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| action | string | обязательный | Выполняемое действие в ответ на команду. |
| post | object | обязательный | Объект с post-параметрами. |
| post.text | string | обязательный, если не передан параметр file_id | Текст сообщения от бота. |
| post.file_id | string | обязательный, если не передан параметр text | Идентификатор файла для сообщения-файла.<br> О получении file_id подробнее расписано в[&nbsp;данном разделе](#post-filegeturl). |
| post.type | string | обязательный | Для текстовых сообщений необходимо передавать в этот параметр значение = "text".<br>Для сообщений-файлов необходимо передавать в этот параметр значение = "file". |

<details><summary>Пример параметров</summary>
<br>

Для отправки текстового сообщения:
```json5 
{
	"answer": {
		"action": "message_send",
		"post": {
			"text": "Привет, это сообщение от бота",
			"type": "text"
		}
	}
}
```

Для отправки файла:
```json5 
{
	"answer": {
		"action": "message_send",
		"post": {
  		    "file_id": "+OVV/dHD03Pb/qRQz9W/FhgupqO6UY0lmbwnG5tz9mHW51N8gA10VvotOzq01GuWq/c5LGZSldSCz4aki...",
		    "type": "file"
		}
	}
}
```

</details>

---

#### `thread_send`

Действие для отправки в тред сообщения от бота на команду пользователя.

Должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| action | string | обязательный | Выполняемое действие в ответ на команду. |
| post | object | обязательный | Объект с post-параметрами. |
| post.text | string | обязательный, если не передан параметр file_id | Текст сообщения от бота. |
| post.file_id | string | обязательный, если не передан параметр text | Идентификатор файла для сообщения-файла.<br> О получении file_id подробнее расписано в[&nbsp;данном разделе](#post-filegeturl). |
| post.type | string | обязательный | Для текстовых сообщений необходимо передавать в этот параметр значение = "text".<br>Для сообщений-файлов необходимо передавать в этот параметр значение = "file". |

<details><summary>Пример параметров</summary>
<br>

Для отправки текстового сообщения:
```json5 
{
	"answer": {
		"action": "thread_send",
		"post": {
		    "text": "Привет, это сообщение от бота в тред",
		    "type": "text"
		}
	}
}
```

Для отправки файла:
```json5 
{
	"answer": {
		"action": "thread_send",
		"post": {
  		    "file_id": "+OVV/dHD03Pb/qRQz9W/FhgupqO6UY0lmbwnG5tz9mHW51N8gA10VvotOzq01GuWq/c5LGZSldSCz4aki...",
		    "type": "file"
		}
	}
}
```

</details>

---

#### `message_addreaction`

Действие для установки реакции на сообщение-команду пользователя.

Должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| action | string | обязательный | Выполняемое действие в ответ на команду. |
| post | object | обязательный | Объект с post-параметрами. |
| post.reaction | string | обязательный | Реакция, которую необходимо установить.<br>Может принимать значение:<br>- короткое описание (short_name). Например, `:blush:`<br>- emoji. Например, 😊 |

Приложение Compass поддерживает список реакций версии 15.0: https://emojipedia.org/emoji-15.0/. <br>

<details><summary>Пример параметров</summary>

```json5 
{
	"answer": {
		"action": "message_addreaction",
		"post": {
  		    "reaction": ":black_cat:"
		}
	}
}
```

</details>

#### Версия webhook бота

Каждый бот приложения Compass имеет версию для webhook, которая позволяет более
гибко взаимодействовать с Userbot API при изменениях API.

При появлении новых изменений бот, используемый вами до изменений, будет иметь ту версию,
которую новые изменения не затронут. И на адрес вашего webhook будут отправляться
данные известного вам формата. 

Чтобы получить новые изменения, необходимо с помощью метода [/webhook/setVersion](#post-webhooksetversion) переключить версию webhook на актуальную.<br>
Подробнее об изменениях миграции и версии webhook: [Migration guide](https://github.com/getCompass/userbot/blob/master/migration_guide.md)

## Список методов Compass Userbot API

| Метод | Для чего используется |
| :--- | :--- |
| [/user/send](#post-usersend) | отправить сообщение от бота конкретному участнику |
| [/group/send](#post-groupsend) | отправить сообщение от бота в группу |
| [/thread/send](#post-threadsend) | отправить сообщение от бота в комментарии к сообщению |
| [/message/addReaction](#post-messageaddreaction) | добавить реакцию на сообщение от лица бота |
| [/message/removeReaction](#post-messageremovereaction) | удалить реакцию бота с сообщения |
| [/user/getList](#post-usergetlist) | получить данные об участниках команды |
| [/group/getList](#post-groupgetlist) | получить данные групп, в которых состоит бот |
| [/command/update](#post-commandupdate) | обновить список команд бота |
| [/command/getList](#post-commandgetlist) | получить список команд бота |
| [/webhook/setVersion](#post-webhooksetversion) | установить версию для webhook бота |
| [/webhook/getVersion](#post-webhookgetversion) | получить текущую версию webhook бота |
| [/file/getUrl](#post-filegeturl) | получить URL для загрузки файлов |

## Описание методов

### `POST /user/send`

Метод для отправки сообщения от бота пользователю.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/user/send`

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| user_id | int | обязательный | ID участника, которому бот отправит сообщение в личный чат. |
| text | string | обязательный, если не передан параметр file_id | Текст сообщения от бота. |
| file_id | string | обязательный, если не передан параметр text | Идентификатор файла для сообщения-файла.<br> О получении file_id подробнее расписано в[&nbsp;данном разделе](#post-filegeturl). |
| type | string | обязательный | Для текстовых сообщений необходимо передавать в этот параметр значение = "text".<br>Для сообщений-файлов необходимо передавать в этот параметр значение = "file". |

Результатом выполнения данного метода будет:<br>
message_id (string) — ключ сообщения, отправленного ботом.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "text": "Привет, это сообщение от бота",
     "type": "text",
     "user_id": 12345
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "message_id": "eNb2VLAPCGFfK1gHzNkH78XNDsPr9N/dDI7f/yaeTof0zjXwv/G000SZFNwqBOx2ACjqSwFjB1Lhgtqn..."
     }
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (например, не передан один из параметров). |
| 1001 | Выбранный участник не существует в команде. |
| 1002 | Выбранный участник покинул команду. |

---

### `POST /group/send`

Метод для отправки сообщения от бота в группу.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/group/send`

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| group_id | string | обязательный | Идентификатор группы, в которое бот отправит сообщение. |
| text | string | обязательный, если не передан параметр file_id | Текст сообщения от бота. |
| file_id | string | обязательный, если не передан параметр text | Идентификатор файла для сообщения-файла.<br> О получении file_id подробнее расписано в[&nbsp;данном разделе](#post-filegeturl). |
| type | string | обязательный | Для текстовых сообщений необходимо передавать в этот параметр значение = "text".<br>для сообщений-файлов необходимо передавать в этот параметр значение = "file". |

Результатом выполнения данного метода будет:<br>
message_id (string) — ключ сообщения, отправленного ботом в группу.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "group_id": "GrrzIL4zDC6a4qX031dzJfqTzl8MD6Rqv2wd38yfGLS6n3brLYUVlCEbNg6A0m6W2X2zkPyY8PN3Ijw6e...",
     "text": "Привет, это сообщение от бота для группы",
     "type": "text"
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "message_id": "eNb2VLAPCGFfK1gHzNkH78XNDsPr9N/dDI7f/yaeTof0zjXwv/G000SZFNwqBOx2ACjqSwFjB1LhgtqnmXFReGjz..."
     }
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (например, не передан один из параметров). |
| 1003 | Бот не состоит в групповом чате. |
| 1004 | Такой групповой чат не существует. |

---

### `POST /thread/send`

Метод для отправки сообщения от бота в тред.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/thread/send`

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| message_id | string | обязательный | Идентификатор сообщения-команды, для которого будет создан тред, если ранее он не был создан, и отправлено сообщение от бота в этот тред. |
| text | string | обязательный, если не передан параметр file_id | Текст сообщения от бота. |
| file_id | string | обязательный, если не передан параметр text | Идентификатор файла для сообщения-файла.<br> О получении file_id подробнее расписано в[&nbsp;данном разделе](#post-filegeturl). |
| type | string | обязательный | Для текстовых сообщений необходимо передавать в этот параметр значение = "text".<br>для сообщений-файлов необходимо передавать в этот параметр значение = "file". |

Результатом выполнения данного метода будет:<br>
message_id (string) — ключ сообщения, отправленного ботом в тред.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "message_id": "oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFx...",
     "text": "Привет, это сообщение от бота в тред",
     "type": "text"
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "message_id": "eNb2VLAPCGFfK1gHzNkH78XNDsPr9N/dDI7f/yaeTof0zjXwv/G000SZFNwqBOx2ACjqSwFj..."
     }
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (например, не передан один из параметров). |
| 1005 | У бота отсутствует доступ к сообщению (сообщение удалено или чат очищен). |
| 1007 | Переданный ID сообщения не существует. |

---

### `POST /message/addReaction`

Метод для добавления реакции на сообщение от лица бота.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/message/addReaction`

Приложение Compass поддерживает список реакций версии 15.0: https://emojipedia.org/emoji-15.0/. <br>

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| message_id | string | обязательный | Идентификатор сообщения, на которое устанавливается реакция от лица бота. |
| reaction | string | обязательный | Реакция, которую необходимо установить.<br>Может принимать значение:<br>- короткое описание (short_name). Например, `:blush:`<br>- emoji. Например, 😊 |

Результатом данного метода будет стандартный ответ "ok" без возвращаемых данных.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "message_id": "oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFxBYmT8v...",
     "reaction": ":blush:"
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {}
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (например, не передан один из параметров). |
| 1005 | У бота отсутствует доступ к сообщению (сообщение удалено или чат очищен). |
| 1006 | Переданная реакция отсутствует в приложении. |
| 1007 | Переданный ID сообщения не существует. |

---

### `POST /message/removeReaction`

Метод для удаления реакции бота с сообщения.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/message/removeReaction`

Приложение Compass поддерживает список реакций версии 15.0:<br>
https://emojipedia.org/emoji-15.0/. <br>

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| message_id | string | обязательный | Идентификатор сообщения, с которого будет удалена реакция бота. |
| reaction | string | обязательный | Реакция, которую необходимо удалить.<br>Может принимать значение:<br>- короткое описание (short_name). Например, `:blush:`<br>- emoji. Например, 😊 |

Результатом данного метода будет стандартный ответ "ok" без возвращаемых данных.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "message_id": "oDT9FLRWjDOX0+4smgkCn039jKIce+NUE90zy9neDKvh6ubLMDGU/Cee5e07avTPFT/WcnAJIXFxBYmT8v...",
     "reaction": ":blush:"
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {}
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (например, не передан один из параметров). |
| 1005 | У бота отсутствует доступ к сообщению (сообщение удалено или чат очищен). |
| 1006 | Переданная реакция отсутствует в приложении. |
| 1007 | Переданный ID сообщения не существует. |

---

### `POST /user/getList`

Метод для получения данных об участниках команды.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/user/getList`

В теле запроса могут использоваться следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| count | int | _необязательный_ | Количество данных в ответе. По умолчанию = 100.<br>Максимум = 300. |
| offset | int | _необязательный_ | Смещение для пагинации данных. По умолчанию = 0. |

Результатом выполнения данного метода будет:<br>
user_list (array) — список с информацией по участникам команды.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{"count": 300, "offset": 0}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "user_list": [
               {
                    "user_id": 1,
                    "user_name": "Иванов Иван",
                    "avatar_file_url": ""
               },
               {
                    "user_id": 2,
                    "user_name": "Михайлов Михаил",
                    "avatar_file_url": "https://file-1.getcompass.com/files/pivot/dca/e8d/632/fa7/51f/fdcaee3ecea91e6c_w400.jpeg"
               }
          ]
     }
}
```

</details>

---

### `POST /group/getList`

Метод для получения информации о группах, в которых состоит бот.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/group/getList`

В теле запроса могут использоваться следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| count | int | _необязательный_ | Количество данных в ответе. По умолчанию = 100.<br>Максимум = 300. |
| offset | int | _необязательный_ | Смещение для пагинации данных. По умолчанию = 0. |

Результатом выполнения данного метода будет:<br>
group_list (array) — список с информацией по групповым чатам бота.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{"count": 50, "offset": 0}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "group_list": [
               {
                    "group_id": "kPyY8PN3Ijw6efI20gVJHGiy4xHOociXAmMh1o/i01gLTS8wHHx7JGrrzIL4zDC6a4qX031dzJfqTzl8MD6Rqv2wd38...",
                    "name": "Библиотека",
                    "avatar_file_url": "https://file-1.getcompass.com/files/c1/cba/30i/de0/2ff/uf3/4128e05b1cbd1f79_w80.jpg"
               },
               {
                    "group_id": "GrrzIL4zDC6a4qX031dzJfqTzl8MD6Rqv2wd38yfGLS6n3brLYUVlCEbNg6A0m6W2X2zkPyY8PN3Ijw6efI20gVJHG...",
                    "name": "Расписание",
                    "avatar_file_url": "https://file-1.getcompass.com/files/c1/cde/b4s/duo/1fc/97t/4128e05b1cbd1f79_w80.jpg"
               },
               {
                    "group_id": "3brLYUVlCEbNg6A0m6W2X2zkPyY8OociXAmMh1o/i01gLTS8wHHx7JGrrzIL4zDC6a4qX031dzJfqTzl8MD6Rqv2wd...",
                    "name": "Статистика",
                    "avatar_file_url": "https://file-1.getcompass.com/files/c1/adf/a1e/pra/4ca/mt5/4128e05b1cbd1f79_w80.jpg"
               }
          ]
     }
}
```

</details>

---

### `POST /command/update`

Метод для обновления списка команд бота.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/command/update`

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| command_list | array | обязательный | Новый список строк-команд для бота (максимум 30 команд для бота). |

Несколько правил для установки команд:

- Длина команды не должна превышать 80 символов.
- Команда может иметь параметры, заключённые в квадратные скобки. В этом
случае паттерн для определения команд для бота "проигнорирует" их при
обработке, посчитав за переданный параметр.
Например, бот в списке команд имеет команду: "отправить сообщение участнику
[ID]". В случае отправки в чат сообщения "/отправить сообщение участнику
[1666]" парсер определит её как команду.
- Команды могут состоять из букв русского и латинского алфавита, цифр и знака
подчёркивания. Например,
> /помощь
>
> /чей клиент [ID]
>
> /установить_таймер 10мин.

Результатом данного метода будет стандартный ответ "ok" без возвращаемых данных.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{
     "command_list": [
          "/помощь",
          "/отправить сообщение пользователю [ID]"
     ]
}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {}
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные (превышена длина для команды). |
| 1008 | Превышен лимит списка команд. |
| 1009 | Некорректная команда в списке. |

---

### `POST /command/getList`

Метод для получения списка команд бота.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/command/getList`

В теле запроса **не требуются** передавать параметры.

Результатом выполнения данного метода будет:<br>
command_list (array) — список команд бота.

<details><summary>Пример результата выполнения запроса</summary>

```json5 
{
     "status": "ok",
     "response": {
          "command_list": [
               "/помощь",
               "/отправить сообщение пользователю [ID]"
          ]
     }
}
```

</details>

---

### `POST /webhook/setVersion`

Метод для установки уровня версии webhook бота.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/webhook/setVersion`

В теле запроса должны быть указаны следующие параметры:

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| version | int | обязательный | Номер версии для webhook бота. |

Результатом данного метода будет стандартный ответ "ok" без возвращаемых данных.

<details><summary>Пример данных для тела запроса и результата выполнения</summary>
<br>

Данные для тела запроса:
```json5 
{"version": 3}
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {}
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные. |
| 1011 | Передана некорректная версия webhook. |

---

### `POST /webhook/getVersion`

Метод для получения уровня версии webhook бота.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/webhook/getVersion`

В теле запроса **не требуются** передавать параметры.

Результатом выполнения данного метода будет:<br>
version (int) — уровень версии webhook бота.

<details><summary>Пример результата выполнения запроса</summary>

```json5 
{
     "status": "ok",
     "response": {
          "version": 2
     }
}
```

</details>

---

### `POST /file/getUrl`

Метод для получения URL ноды, куда загружаются файлы.
Предназначен для дальнейшего получения параметра file_id для отправки сообщения-файла.<br>
URL для запроса: `https://userbot.getcompass.com/api/v3/file/getUrl`

В теле запроса **не требуются** передавать параметры.

Результатом выполнения данного метода будет:<br>
node_url — URL-адрес сервера, на который возможно загрузить файл;<br>
file_token — токен для валидации запроса загрузки файла.

<details><summary>Пример результата выполнения запроса</summary>

```json5 
{
     "status": "ok",
     "response": {
          "node_url": "https://file1.getcompass.com/api/userbot/files/upload",
          "file_token": "404952d4ac90ae960de4d2a96fb95d306493e151"
     }
}
```

</details>

---

После получения URL сервера, появится возможность загрузить файл POST-запросом с помощью [multipart/form-data](https://ru.wikipedia.org/wiki/Multipart/form-data), подписав запрос полученным file-токеном.

В нашем случае с полученными из ответа node_url и токеном для загрузки файла запрос будет выглядеть следующим образом:<br>
URL для запроса: `https://file1.getcompass.com/api/userbot/files/upload`

| Название | Тип | Свойство | Описание |
| -------- | --- | --- | -------- |
| token | string | обязательный | file_token для валидации загрузки файла. |
| file | string/binary | обязательный | Содержимое файла для загрузки. |

⚠️ Ограничения для загрузки файла:

- максимальный размер файла — 256 MB;
- один токен разрешает загрузку одного файла, т.е. с его помощью невозможно загрузить второй файл;
- для загрузки доступно не более 50 файлов в течение 5 минут.

После успешной загрузки файла в ответе от метода вернётся:<br>

file_id (string) — уникальный идентификатор загруженного файла.

<details><summary>Пример запроса и результата выполнения запроса</summary>

Пример запроса:
```json5 
token: "404952d4ac90ae960de4d2a96fb95d306493e151", // значение полученного file_token
file: "(binary)"                                   // бинарные данные загружаемого файла
```

Результат выполнения запроса:
```json5 
{
     "status": "ok",
     "response": {
          "file_id": "+OVV/dHD03Pb/qRQz9W/FhgupqO6UY0lmbwnG5tz9mHW51N8gA10VvotOzq01GuWq/c5LGZSldSCz4aki..."
     }
}
```

</details>

Список возможных ошибок:

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные. |
| 1010 | Не удалось загрузить файл. |

---

### Дополнительное форматирование сообщений

Боту доступен функционал, позволяющий упомянуть участника в отправленном сообщении:

| <img src="./screenshots/ru/13.png" alt="" width="550" /> |
| --- |

Для этого текст сообщения должен иметь формат вида:</br>
`["@"|<числовой идентификатор user_id>|"<имя участника>"]`

На примере выше представим, что у Фёдора Денисова ID участника соответствует 345. Для получения сообщения, как в примере, текст отправленного от бота сообщения должен иметь вид:</br>
`["@"|345|"Фёдор Денисов"] данные сформированы ✅`

---

Бот также обладает теми же возможностями форматирования сообщений, что и участник команды в приложении Compass.

Например, можно изменить вид шрифта или выделить слова определённым цветом:
- для создания жирного шрифта текста: \*жирный шрифт\*
- для создания курсива в тексте: \_курсив\_
- для создания зачёркнутого текста: \~зачёркнутый текст\~
- текст на чёрном фоне: \``текст на чёрном фоне\``
- текст, выделенный зелёным: \++зелёное выделение\++
- текст, выделенный розовым: \--розовое выделение\--

| <img src="./screenshots/ru/14.png" alt="" width="550" /> |
| --- |


## Ошибки при выполнении запроса Compass Userbot API

В случае если при выполнении запроса произошла ошибка, то возвращается ответ следующего формата:

```json5 
{
     "status": "error",
     "response": {
          "error_code": 1,
          "message": "missing required fields for request"
     }
}
```
- status "error" — сообщает о том, что запрос завершился ошибкой;
- error_code — специальный код ошибки;
- message — произвольный текст для описания ошибки.

---

Ниже приведён список **системных ошибок**, которые возвращаются при передаче
некорректных данных, а также в случае, если запрос ещё не выполнен.

| error_code | Описание |
| --- | --- |
| 1 | Отсутствуют обязательные поля для запроса. |
| 2 | Токен запроса не найден. |
| 3 | Бот выключен или удалён — выполнение запроса невозможно. |
| 5 | Достигнут лимит ошибок при выполнении запроса. |
| 6 | Неизвестная ошибка при выполнении внутреннего метода для запроса. |
| 8 | Указаны некорректные параметры для запроса. |
| 9 | Указан некорректный метод запроса. |

---

Ниже приведён **список ошибок**, которые возвращаются **при неуспешной попытке
выполнить запрос**, например, при попытке от лица бота написать пользователю, который
удалил аккаунт в приложении.

| error_code | Значение |
| --- | --- |
| 1000 | Переданы некорректные данные. |
| 1001 | Выбранный участник не существует в команде. |
| 1002 | Выбранный участник покинул команду |
| 1003 | Бот не состоит в группе. |
| 1004 | Такой группы не существует. |
| 1005 | У бота отсутствует доступ к сообщению (сообщение удалено или чат очищен). |
| 1006 | Переданная реакция отсутствует в приложении. |
| 1007 | Переданный ID сообщения не существует. |
| 1008 | Превышен лимит списка команд. |
| 1009 | Некорректная команда в списке. |
| 1010 | Не удалось загрузить файл. |
| 1011 | Передана некорректная версия webhook. |

## Библиотека для работы с API ботов приложения Compass

Для вашего удобства мы создали библиотеку для взаимодействия с приложением Compass Userbot API:

[Библиотека для работы с API ботов](https://github.com/getCompass/php_lib_userbot/blob/master/README_ru.md). <br>
